<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Деревотряска</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/wrike.css">
    <link rel="stylesheet" href="style.css" media="all">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
    <style>
      .reveal .solid {
        width: 2ex;
        display:inline-block;
        text-align:center;
        font-weight: 400;
      }
      .reveal li {
        margin-bottom: .5em;
      }
      .reveal pre.opacity * {
        color: rgba(255,255,255, 0.3) !important;
      }
      .reveal .tag {
        width: 12ex;
        display:inline-block;
        float: left;
        font-weight:500;
      }

      .reveal pre.opacity mark,
      .reveal pre.opacity mark * {
        color: rgba(255,255,255, 1) !important;
        background-color:transparent;
      }

      .reveal mark,
      .reveal mark * {
        font-weight: 600;
      }

      .reveal ul.solid-ul li {
        list-style:none;
      }

      .hidden {
        visibility:hidden;
      }
    </style>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          Метапрограммирование
        </section>
        <section data-background="./img/magic.gif"></section>
        <section data-background="./img/magic2.gif"></section>
        <section>
          <b>Мета</b> &mdash; μετά &mdash; «между, после, через»
        </section>
        <section>
          следование, превращение, переход к другому состоянию, выход за пределы
        </section>
        <section>
          <blockquote>
            <p>
              Данные - это всего лишь лишенная смысла разновидность программирования
            </p>
            <cite>
              Билл Госпер
            </cite>
          </blockquote>
        </section>
        <section>
          Программы создают программы
        </section>
        <section>
          <h2>Явная генерация</h2>
        </section>

        <section>
          <p>
            Скаффолдинг
          </p>
          <p>
            «строительные леса»
          </p>
        </section>
        <section>
          <p>Что можно нагенерировать</p>
          <ul>
            <li class="fragment">
              MVC код
            </li>
            <li class="fragment">
              Код для миграции БД
            </li>
            <li class="fragment">
              Все что угодно
            </li>
          </ul>
        </section>
        <section>
          <p>Node</p>
          <p>
            Yeoman &mdash; <a href="http://yeoman.io/">yeoman.io</a>
          </p>
        </section>
        <section>
          <p>
          <img src="img/hipster.svg" width="300px" alt="">
          </p>
          <p>JHipster</p>
          <a href="https://www.jhipster.tech/">jhipster.tech</a>
        </section>
        <section>
          <p>Клиент</p>
          <img src="img/Screen Shot 2018-07-20 at 10.17.01.png" alt="">
        </section>
        <section>
          <p>Сервер</p>
          <img style="max-height: 85vh" src="img/Screen Shot 2018-07-20 at 10.17.15.png" alt="">
        </section>
        <section>
          <p>Деплой</p>
          <img style="max-height: 85vh" src="img/Screen Shot 2018-07-20 at 10.17.15.png" alt="">
        </section>
        <section>
          <p>CI</p>
          <img src="img/Screen Shot 2018-07-20 at 10.17.27.png" alt="">
        </section>
        <section>
          <img src="img/Screen Shot 2018-07-20 at 10.24.29.png" alt="">
        </section>
        <section>
          Java
          <p class="fragment">
          <a href="https://github.com/javaparser/javaparser">github.com/javaparser/javaparser</a>
          </p>
        </section>
        <section>
          <p>Dart</p>
          <ul>
            <li class="fragment">code_builder</li>
            <li class="fragment">analyzer</li>
            <li class="fragment">build (build_runner)</li>
          </ul>
        </section>
        <section>
          <p>Плюсы</p>
          <ul>
            <li class="fragment">Быстро</li>
            <li class="fragment">Работает</li>
            <li class="fragment">Можно прокачаться</li>
            <li class="fragment">Меньше кода</li>
          </ul>
        </section>
        <section>
          <p>Минусы</p>
          <ul>
            <li class="fragment">Сложно понимать</li>
            <li class="fragment">Сложно писать</li>
            <li class="fragment">Теряем контроль</li>
            <li class="fragment">Нужно перегенерировать</li>
          </ul>
        </section>
        <section>
          <h2>Неявная генерация</h2>
        </section>
        <section data-transition="none">
          <p>Javascript</p>
        </section>
        <section data-transition="none">
          <strike>Javascript</strike>
        </section>
        <section>
          <p>
            На самом деле их много...
          </p>
          <ul>
            <li class="fragment">
              Webpack, Rollup, Gulp...
            </li>
            <li class="fragment">
              Babel, Typescript, Dart2js, DartDevc, Flow
            </li>
          </ul>
        </section>
        <section>
          <p>Dart</p>
        </section>
        <section>
          <p class="fragment">Dart</p>
          <img src="img/transformers.png" alt="">
        </section>
        <section data-transition="none">
            Трансформеры
        </section>
        <section data-transition="none">
          <strike>
            Трансформеры
          </strike>&nbsp;&nbsp;(Deprecated)
        </section>
        <section>
          <p>
          build & build_runner
          </p>
          <ul>
            <li class="fragment">Reflectable</li>
          </ul>
        </section>
        <section data-transition="none">
          <pre><code style="max-height: 80vh" data-trim>
import 'package:reflectable/reflectable.dart';
import 'main.reflectable.dart'; // Import generated code.

// Annotate with this class to enable reflection.
class Reflector extends Reflectable {
  const Reflector() : super(invokingCapability);
}

const reflector = const Reflector();

@reflector // This annotation enables reflection on A.
class A {}
          </code></pre>
        </section>
        <section data-transition="none">
          <pre><code style="max-height: 80vh" data-trim data-noescape>
import 'package:reflectable/reflectable.dart';
<mark>import 'main.reflectable.dart'</mark>; // Import generated code.

// Annotate with this class to enable reflection.
class Reflector extends Reflectable {
  const Reflector() : super(invokingCapability);
}

const reflector = const Reflector();

@reflector // This annotation enables reflection on A.
class A {}
          </code></pre>
        </section>
        <section>
          <p>
          build & build_runner
          </p>
          <ul>
            <li >Reflectable</li>
            <li class="fragment" >Less to CSS</li>
            <li class="fragment">Angular templates <span class="fragment">(AOT compiler)</span></li>
            <li class="fragment" >Angular DI</li>
          </ul>
        </section>
        <section>
          <pre><code data-trim>
import 'package:angular/angular.dart';
import 'package:an/app_component.template.dart' as ng;

void main() {
  runApp(ng.AppComponentNgFactory);
}
          </code></pre>
        </section>
        <section>
          <img src="img/di.png" alt="">
        </section>
        <section>
          <p>
            Java
          </p>
        </section>
        <section>
          Lombok
        </section>
        <section>
          <pre><code data-trim>
@Getter
@Setter
private int age = 10;
          </code></pre>
        </section>
        <section>
          <pre><code data-trim>
private int age = 10;

public int getAge() {
 return age;
}

public void setAge(int age) {
  this.age = age;
}
          </code></pre>
        </section>
        <section>
          <p>Groovy</p>
          <pre ><code  style="font-size: 4vh" data-trim>
import groovy.transform.Canonical
import groovy.transform.TupleConstructor

@Canonical
@TupleConstructor
class Person {
    int id
    String firstName
    String lastName
    Date birthdate
}
          </code></pre>
        </section>
        <section>
          <p>
            После компиляции получаем:
          </p>
          <pre><code data-trim style="max-height: 100vh">
import java.util.Date;
import java.util.Map;

public class Person {
    private int id;
    private String firstName;
    private String lastName;
    private Date birthdate;

    //Эта штука добавлена @TupleConstructor-ом
    public Person(Map parameters){
        this.id = (int) parameters.get("id");
        this.firstName = (String) parameters.get("firstName");
        this.lastName = (String) parameters.get("lastName");
        this.birthdate = (Date) parameters.get("birthdate");
    }

    public Person(int id, String firstName, String lastName, Date birthdate) {
        this.id = id;
        this.firstName = firstName;
        this.lastName = lastName;
        this.birthdate =birthdate;
    }

    public Person(int id, String firstName, String lastName) {
        this(id, firstName, lastName, null);
    }

    public Person(int id, String firstName) {
        this(id, firstName, null, null);
    }

    public Person(int id) {
        this(id, null, null, null);
    }

    public Person() {
        this(0, null, null, null);
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;

        Person person = (Person) o;

        if (id != person.id) return false;
        if (birthdate != null ? !birthdate.equals(person.birthdate) : person.birthdate != null) return false;
        if (firstName != null ? !firstName.equals(person.firstName) : person.firstName != null) return false;
        if (lastName != null ? !lastName.equals(person.lastName) : person.lastName != null) return false;

        return true;
    }

    @Override
    public int hashCode() {
        int result = id;
        result = 31 * result + (firstName != null ? firstName.hashCode() : 0);
        result = 31 * result + (lastName != null ? lastName.hashCode() : 0);
        result = 31 * result + (birthdate != null ? birthdate.hashCode() : 0);
        return result;
    }

    @Override
    public String toString() {
        return "Person{" +
                "id=" + id +
                ", firstName='" + firstName + '\'' +
                ", lastName='" + lastName + '\'' +
                ", birthdate=" + birthdate +
                '}';
    }

    public int getId() {
        return this.id;
    }

    public void setId(int paramInt) {
        this.id = paramInt;
    }

    public String getFirstName() {
        return this.firstName;
    }

    public void setFirstName(String paramString) {
        this.firstName = paramString;
    }

    public String getLastName() {
        return this.lastName;
    }

    public void setLastName(String paramString) {
        this.lastName = paramString;
    }

    public Date getBirthdate() {
        return this.birthdate;
    }

    public void setBirthdate(Date paramDate) {
        this.birthdate = paramDate;
    }
}
          </code></pre>
        </section>
        <section data-transition="none">
          <pre ><code  style="font-size: 4vh" data-trim>
import groovy.transform.Canonical
import groovy.transform.TupleConstructor

@Canonical
@TupleConstructor
class Person {
    int id
    String firstName
    String lastName
    Date birthdate
}
          </code></pre>
        </section >
        <section data-transition="none">
          <pre ><code  style="font-size: 4vh" data-trim>
import groovy.transform.Canonical
import groovy.transform.TupleConstructor

@Canonical
@TupleConstructor
@WrikeSuperAnnotation
@WrikeSuperMegaAnnotation
@VasyaPupkinSuperMegaAnnotation
class Person {
    int id
    String firstName
    String lastName
    Date birthdate
}
          </code></pre>
        </section>
        <section>
          <h2>RUNTIME</h2>
        </section>
        <section>
          Java
          <p class="fragment">
            Здесь все хорошо, даже слишком
          </p>
        </section>
        <section>
          Javascript
        </section>
        <section>
          <p>Старая школа</p>
          <pre><code>
var fullName = (firstName, lastName) =>
firstName + " " + lastName
console.log(argNames(fullName));
          </code></pre>
// ["firstName", ”lastName"]
        </section>
        <section data-transition="none">
          <pre><code data-noescape data-trim>
var argNames = (f) => {
 let funcDef = f.toString();
 let headRegex = /\(([\s\S]*?)\)/;
 let head = headRegex.exec(funcDef)[1];
 let argCands = head.split(/[ ,\n\r\t]+/);
 let names = argCands.filter((x) => x);
 return names;
}
          </code></pre>
        </section>
        <section data-transition="none">
          <pre><code data-noescape data-trim>
var argNames = (f) => {
 <mark>let funcDef = f.toString();</mark>
 let headRegex = /\(([\s\S]*?)\)/;
 let head = headRegex.exec(funcDef)[1];
 let argCands = head.split(/[ ,\n\r\t]+/);
 let names = argCands.filter((x) => x);
 return names;
}
          </code></pre>
        </section>
        <section>
          <p>Объекты Proxy</p>
          <pre><code data-trim>
var handler = {
  get: function(target, name) {
    return name in target ? target[name] : 42;
}};
var p = new Proxy({}, handler);
p.a = 1;
console.log(p.a, p.b); // 1, 42
          </code></pre>
        </section>
        <section>
          <p>
            Отзываемый Proxy
          </p>
          <pre><code data-trim>
var revocable = Proxy.revocable({}, {
  get: function(target, name) {
    return '[[' + name + ']]';
  }
});
var proxy = revocable.proxy;
console.log(proxy.foo); // "[[foo]]"

revocable.revoke();

console.log(proxy.foo);  // ошибка TypeError
          </code></pre>
        </section>
        <section>
          <p>Reflect</p>
          <pre class="fragment"><code data-trime>
Reflect.has(Object, 'assign'); // true
          </code></pre>
          <br>
          <pre class="fragment"><code data-trim>
// Function.prototype.apply.call(Math.floor, undefined, [1.75]);
Reflect.apply(Math.floor, undefined, [1.75]);
          </code></pre>
          <br>
          <pre class="fragment"><code data-trime>
if (Reflect.defineProperty(target, property, attributes)) {
  // успех
} else { // что-то пошло не так
}
          </code></pre>
        </section>
        <section>
          Также уже почти завезли декораторы
        </section>
        <section>
          <pre><code>
class Cat { meow() { return `${this.name} says Meow!`} }
          </code></pre>
          <div class="fragment">
<p>Тоже самое</p>
          <pre><code>
Object.defineProperty(Cat.prototype, 'meow', {
    value: specifiedFunction,
    enumerable: false,
    configurable: true,
    writable: true
  });
          </code></pre>
          </div>
        </section>
        <section>
          <pre><code data-trim>
function readonly(target, key, descriptor) {
    descriptor.writable = false;
    return descriptor;
  }
          </code></pre>
        </section>
        <section>
          <p>Ошибка! Так как мы не можем изменять реализацию метода.</p>
          <pre><code data-trim>
let garfield = new Cat();
garfield.meow = () => { console.log('I want lasagne!'); };
          </code></pre>
        </section>
        <section data-transition="none">
          Dart
          <p class="fragment">
            её нет
          </p>
        </section>
        <section data-transition="none">
          Dart
          <p>
            её <strike>почти</strike> нет
          </p>
          <p class="fragment">
            noSuchMethod(Invocation invocation);
          </p>
        </section>
        <section>
          <p>Использование в тестах</p>
          <pre  class="fragment"><code data-trim>
class Car {
  String get company => 'BMW';
}
          </code></pre>
          <br>
          <pre class = fragment>

<code data-trim>
  abstract class Mock {
    dynamic noSuchMethod(Invocation i){
      if(i.memberName == Symbol('company')){
        return 'Lada';
      }
      return null;
    }
  }
</code>
          </pre>
        </section>
        <section>
          <pre><code data-trim>
class CarMock extends Mock implements Car {}
          </code></pre>
          <br />
          <pre class="fragment"><code data-trim>
void main(){
  final c = new CarMock();
  print(c.company);
} // Lada
          </code></pre>
        </section>
        <section>
          <p>Добавим аргументов</p>
          <pre><code data-trim>
class Car {
  String company(String a) => a;
}
          </code></pre>
        </section>
        <section>
          <pre><code style="max-height: 80vh" data-trim>
dynamic noSuchMethod(Invocation i) {
    final realCar = new Car();
    final nameArg = i.positionalArguments[0];

    bool isNull = nameArg == null;
    bool isCompany = i.memberName == Symbol('company');

    if(isCompany){
      return isNull? 'Lada': realCar.company(nameArg);
    }
  }
          </code></pre>
        </section>
        <section>
          <pre>
              <code data-trim>
void main() {
  final c = new CarMock();
  print(c.company(null)); // Lada
  print(c.company('BMW')); // BMW
}
              </code>
          </pre>
        </section>
        <section>
          Просим помощи у JS
        </section>
        <section data-transition="none">
          <p>Дано</p>
          <pre><code data-trim data-noescape>
void main(){
  new List&lt;Apple&gt;()
    ..add(Apple())
    ..add(Orange());
}
          </code></pre>
          <p>&nbsp;</p>
        </section>
        <section data-transition="none">
          <p>Дано</p>
          <pre><code data-trim data-noescape>
void main(){
  new List&lt;Apple&gt;()
    ..add(Apple())
    <mark>..add(Orange());</mark>
}
          </code></pre>
          <p class="fragment">as упадет</p>
        </section>
        <section>
          <pre><code data-trim data-noesape>
// Dart
@JS('id')
external T id&lt;T&gt;(dynamic input);
          </code></pre>
          <br>
          <pre><code class="fragment" data-trim>
// Java Script
window.id = (id) => id;
          </code></pre>
        </section>
        <section>
          <pre><code data-trim data-noescape>
  final list = new List<Orange>()
    ..add(Orange())
    ..add(id&lt;Orange&gt;(Apple()));
          </code></pre>
        </section>
        <section>
          Таким образом можно:
          <ul>
            <li class="fragment">
              Заюзать Proxy из JS
            </li>
            <li class="fragment">
              Заменить реализацию методе в рантайме
            </li>
            <li class="fragment">
              Получить люлей за неадекватный код на ревью
            </li>
          </ul>
        </section>
        <section>
          <h2>
          Когда нужно метопрограмирование:
          </h2>
        </section>
        <section>
          <ul>
            <li>
              Когда есть DI
            </li>
            <li class="fragment">
              Когда у вас статическая типизация
            </li>
            <li class="fragment">
              Когда вы в тупике
            </li>
          </ul>
        </section>
        <section>
          Для чего на самом деле нужна статическая типизация
        </section>
        <section>
          <img src="img/_2.jpg" alt="">
        </section>
        <section>
          <img src="img/_1.jpg" alt="">
        </section>
        <section>
          <pre><code data-trim>
          #define TRUE (random()>0.5)
          //счастливой отладки, суки
          </code></pre>
        </section>
      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
      // More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.initialize({
  controls: true,
  width: 1280,
	height: 1024,
  progress: true,
  slideNumber: true,
  history: true,
  dependencies: [
    { src: 'plugin/markdown/marked.js' },
    { src: 'plugin/markdown/markdown.js' },
    { src: 'plugin/notes/notes.js', async: true },
    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
  ]
});
    </script>
  </body>
</html>
